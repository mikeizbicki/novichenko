{% extends "base.html" %}

{% block header %}
<header class=grid>
<div class="header logo">
<img src='/static/en-chajda.png' width=120px height=30px>
</div>
<div class="header search box">
<form id=form_search onsubmit='load_all_data(); return false;'>
    <!--action='/search' method='get'> -->
    <input type=text name=query value='{{query}}' />
    {% if time_lo_args %}
    <input type=hidden name=time_lo value='{{time_lo_args}}' />
    {% endif %}
    {% if time_hi_args %}
    <input type=hidden name=time_hi value='{{time_hi_args}}' />
    {% endif %}
    <button type="submit"><i class="fa fa-search"></i></button>
    <select name="lang" id="lang">
      <option value="en" {%if lang=="en" %}selected{%endif%}>en</option>
      <option value="es" {%if lang=="es" %}selected{%endif%}>es</option>
    </select>
</form>
</div>
</header>
{% endblock %}

{% block content %}
<script>
var window_size = 1;
function load_all_data() {
    load_count();
    load_projection();
    load_documents();
    draw_documents();
}
</script>



<aside id=aside_xy style='grid-row: 1'>
    <h3>Mentions Options</h3>
    <ul>
        <li>axis
            <select name="mentions_axis" id="mentions_axis" form=form_search>>
              <option value="host"    {%if mentions_axis=="host"     %}selected{%endif%}>host</option>
              <option value="hostpath"{%if mentions_axis=="hostpath" %}selected{%endif%}>hostpath</option>
            </select>
            <script>
                document.getElementById('mentions_axis').addEventListener('change', load_all_data);
            </script>
        </li>
        <li>normalization
            <select name="normalize" id="normalize" form=form_search>>
              <option value="none" {%if normalize=="none"     %}selected{%endif%}>none</option>
              <option value="total"{%if normalize=="total"    %}selected{%endif%}>total</option>
              {% for selected,term_combination in terms_combinations_pretty %}
              <option value='query:{{term_combination|safe}}' {%if selected%}selected{%endif%}>query:{{term_combination|safe}}</option>
              {% endfor %}
            </select>
            <script>
                document.getElementById('normalize').addEventListener('change', load_all_data);
            </script>
        </li>
        <li>granularity
            <select name="granularity" id="granularity" form=form_search>
              <option value="year"  selected>year</option>
              <option value="month"         >month</option>
              <option value="day"           >day</option>
            </select>
            <script>
                document.getElementById('granularity').addEventListener('change', load_all_data);
            </script>
        </li>
    </ul>
</aside>
<aside id=aside_x2y2 style='grid-row:2'>
    <h3>Projection Options</h3>
    <ul>
        <li>axis
            <select name=projection_axis id=projection_axis form=form_search>
            </select>
            <script>
                var axis_dictionary = {
                    'anger': ['angry agitated', 'calm serene'],
                    'gender': ['female mother queen she', 'male father king he'],
                    'happiness': ['sad misery dissatisfaction bore', 'happy joy pleasure delight'],
                    'intelligence': ['intelligent', 'stupid'],
                    'freedom': ['oppression', 'freedom'],
                    'scary': ['relaxing unafraid comfort','scary afraid fear'], 
                    'sentiment': ['positive good better best', 'negative bad worse worst'], 
                    'success': ['successful', 'failed'],
                    'threat': ['safety peace friend ally', 'danger war menace enemy'],
                    'truth': ['truth', 'lie'],
                    'war': ['peace', 'war'],
                    'wealth': ['wealth affluence rich asset', 'debt poverty poor liability'],
                    //'life': ['alive active awake living', 'dead inactive asleep dying'],
                    //'erotic': ['erotic sexy sensual', 'unerotic polite propper'],
                };
                projection_axis = getParameterByName('projection_axis');
                select = document.getElementById('projection_axis')
                for (key in axis_dictionary) {
                    option = document.createElement("option");
                    option.textContent = key;
                    option.value = key;
                    if (projection_axis == key) {
                        option.selected = 'selected';
                    }
                    select.add(option);
                }
                function set_projection_axis(e) {
                    document.getElementById('pos_words').value = axis_dictionary[e.currentTarget.value][0];
                    document.getElementById('neg_words').value = axis_dictionary[e.currentTarget.value][1];
                    load_all_data();
                }
                document.getElementById('projection_axis').addEventListener('change', set_projection_axis);
            </script>
            <br>
            pos words <input id=pos_words name=pos_words form=form_search readonly value="{{pos_words}}">
            <br>
            neg words <input id=neg_words name=neg_words form=form_search readonly value="{{neg_words}}">
            <br>
            <a href='/wordcloud?pos_words={{pos_words}}&neg_words={{neg_words}}&dim=25'>visualize projection</a>
            <br>
            <br>
        </li>
        <li>
            <input form=form_search type="checkbox" id="rm_vh_data" name="rm_vh_data" value="True" checked><label for="rm_vh_data">rm_vh_data</label><br>
            <input form=form_search type="checkbox" id="rm_vh_hardcoded" name="rm_vh_hardcoded" value="True" checked><label for="rm_vh_hardcoded">rm_vh_hardcoded</label><br>
    <script>
    document.getElementById('rm_vh_data').addEventListener('change', load_all_data);
    document.getElementById('rm_vh_hardcoded').addEventListener('change', load_all_data);
    </script>
        </li>
        <li>window size 
            <br>
            <input type="range"  id="window_size_range" min="1" max="24" value="1" oninput="set_window_size(this.value)" />
            <br>
            <input type="number" id="window_size_number" min="1" max="24" value="1" oninput="set_window_size(this.value)" />
            <script>
            function set_window_size(window_size_new) {
                console.log('set_window_size()');
                window_size = window_size_new;
                document.getElementById('window_size_range').value = window_size;
                document.getElementById('window_size_number').value = window_size;
                plotly_redraw();
            }
            </script>
        </li>
    </ul>
</aside>

<div style='display:grid; grid-column:1; grid-row:1;'>
    <h2 class=label>Counts</h2>
</div>
<div style='display:grid; grid-column:1; grid-row:2;'>
    <h2 class=label>Projection</h2>
</div>

<div id=plotly></div>
<!--
<div style='display:grid;' id=plotly_container>
<div style='grid-area:1/1;' id=plotly_loading>
    <img src=/static/Ajax_loader_metal_512.gif'>
</div>
</div>
-->




<aside style="grid-row:3">
    <h3>Document Options</h3>
Order by
<select name="orderby" id="orderby">
  <option value="none"      {%if orderby=="none"     %}selected{%endif%}>none</option>
  <option value="time_desc" {%if orderby=="time_desc"%}selected{%endif%}>publication date (descending)</option>
  <option value="time_asc"  {%if orderby=="time_asc" %}selected{%endif%}>publication date (ascending)</option>
  <option value="rank"      {%if orderby=="rank"     %}selected{%endif%}>relevance</option>
</select>
<script>
document.getElementById('orderby').addEventListener('change', load_all_data);
</script>
</aside>

<div style='display:grid; grid-column:1; grid-row:3'>
    <h2 class=label>Documents</h2>
</div>
<div style='display:grid; grid-column:2; grid-row:3'>

<h4>Documents</h4>

<div id=documents>
</div>
</div>


<script>

function add_randoms(projection_data_raw, max_points=10000.0) {
    let randoms = [];
    let xs = [];
    let total_elements = projection_data_raw['counts'].reduce((a, b) => a + b, 0);
    let total_randoms = Math.min(max_points,total_elements);
    let xs_index = 0;
    let randoms_at_index = 0;
    let stddev = calc_stddev(projection_data_raw['projections']);

    for (var i=0; i<total_randoms && xs_index <projection_data_raw['xs'].length; i++) {
        randoms_at_index += 1
        if (randoms_at_index > projection_data_raw['counts'][xs_index]/total_elements*total_randoms) {
            xs_index += 1;
            randoms_at_index = 0;
            i -= 1;
        }
        else {
            if (projection_data_raw['projections'][xs_index] !== null) {
                xs.push(projection_data_raw['xs'][xs_index])
                // FIXME:
                // this uses the Box-Muller transform to convert two uniform random variables into two normal random variables;
                // the current implementation is 2x slower than it could be since we discard one of the normal random variables
                let r1 = Math.random();
                let r2 = Math.random();
                let random = stddev * Math.sqrt(-2*Math.log(r1))*Math.cos(2*Math.PI*r2);
                randoms.push(projection_data_raw['projections'][xs_index]+random);
            }
        }
    }
    var projection_data = {
        'xs' : projection_data_raw['xs'].concat(xs),
        'projections' : projection_data_raw['projections'].concat(randoms),
        'counts' : projection_data_raw['counts'],
        };

    projection_data['dots'] = 0;
    for (let i=0; i<projection_data['projections'].length; i++) {
        if (projection_data['projections'][i]) {
            projection_data['dots'] += 1;
        }
    }
    return projection_data;
}


</script>

<script>

var count_data = null;
var projection_data = null;

function plotly_redraw(newPlot=false) {

    var trace_count = {
      hovermode: 'closest',
      hovertemplate: '',
      type: 'scattergl',
      line: {
        shape: 'hv',
        color: '#55f',
        width: 1,
      },
      marker: {
        size: 1,
      },
    };

    var trace_count_lo = Object.assign({}, trace_count);
    trace_count_lo.line = {
        hovermode: false,
        hovertemplate: false,
        shape: 'hv',
        color: '#ccf',
        width: 1,
      };

    var trace_count_hi = Object.assign({}, trace_count_lo);

    if (count_data) {
        trace_count.x = count_data['xs'];
        trace_count.y = count_data['term_counts'];
        trace_count_lo.x = count_data['xs'];
        trace_count_lo.y = count_data['term_counts_lo'];
        trace_count_hi.x = count_data['xs'];
        trace_count_hi.y = count_data['term_counts_hi'];
    }
    else {
        trace_count.x = ['1960-01-01 00:00:00', '2022-01-01 00:00:00'];
        trace_count.y = [null, null];
        trace_count_lo.x = ['1960-01-01 00:00:00', '2022-01-01 00:00:00'];
        trace_count_lo.y = [null, null];
        trace_count_hi.x = ['1960-01-01 00:00:00', '2022-01-01 00:00:00'];
        trace_count_hi.y = [null, null];
    }

    var trace_projection_dots = {
      xaxis: 'x2',
      yaxis: 'y2',
      type: 'scattergl',
      hoverinfo: 'skip',
      line: {
        shape: 'hv',
        color: '#55f',
        width: 1,
      },
      mode: 'markers',
    }

    var trace_projection_ave = {
      xaxis: 'x2',
      yaxis: 'y2',
      type: 'scattergl',
      hoverinfo: 'closest',
      line: {
        shape: 'spline',
        color: '#55f',
        width: 1,
      },
      marker: {
        size: 1,
      },
    };

    if (projection_data) {
        trace_projection_dots.x = projection_data['xs'];
        trace_projection_dots.y = projection_data['projections'];
        trace_projection_dots.marker = {
            size: 2+2*Math.max(0,1-projection_data['dots']/10000)+2*Math.max(0,1-projection_data['dots']/100),
            color: '#ccf',
        };
        trace_projection_ave.x = projection_data['xs'];
        trace_projection_ave.y = moving_average([],projection_data['projections'].slice(0,projection_data['counts'].length),window_size,projection_data['counts']);
    }
    else {
        trace_projection_dots.x = ['1960-01-01 00:00:00', '2022-01-01 00:00:00'];
        trace_projection_dots.y = [null, null];
        trace_projection_ave.x = ['1960-01-01 00:00:00', '2022-01-01 00:00:00'];
        trace_projection_ave.y = [null, null];
    }

    var data = [trace_count_lo, trace_count_hi, trace_count, trace_projection_dots, trace_projection_ave];

    var layout = {
        grid: {rows: 2, columns: 1},
        showlegend: false,
        margin:{
            l:60,
            r:0,
            t:0,
            b:0,
            pad:0,
        },
        xaxis: {
            autorange: true,
            rangeselector: {
              buttons: [
                {
                  count: 1,
                  label: '1y',
                  step: 'year',
                  stepmode: 'backward'
                },
                {
                  count: 10,
                  label: '10y',
                  step: 'year',
                  stepmode: 'backward'
                },
                {
                  count: 100,
                  label: '100y',
                  step: 'year',
                  stepmode: 'backward'
                },
                {step: 'all'}
              ]},
            //rangeslider: {},
            type: 'date'
        },
        xaxis2: {
          matches: 'x',
        },
        yaxis: {
          fixedrange: true,
          rangemode: 'tozero',
          title: {
            text: 'count',
            font: {
              family: 'Courier New, monospace',
              size: 18,
              color: '#7f7f7f'
            }
          }
        },
        yaxis2: {
          fixedrange: true,
          rangemode: 'tozero',
          title: {
            text: 'projection',
            font: {
              family: 'Courier New, monospace',
              size: 18,
              color: '#7f7f7f'
            }
          }
        }
    };

    if (newPlot) {
        Plotly.newPlot('plotly', data, layout, {displaylogo: false});
        console.log('plotly_redraw(true)');
    }
    else {
        Plotly.react('plotly', data, layout, {displaylogo: false});
        console.log('plotly_redraw(false)');
    }
};
plotly_redraw(true);

/*
FIXME
    document.getElementById('plotly').on('plotly_relayout',
    function(eventdata){
        var url = window.location.href;
        var time_lo = eventdata['xaxis.range[0]'];
        if (time_lo) {
            if (getParameterByName('granularity') == 'day')
                time_lo = time_lo.toString().slice(0,10);
            if (getParameterByName('granularity') == 'month')
                time_lo = time_lo.toString().slice(0,7)+'-01';
            url = updateURLParameter(url, 'time_lo', time_lo);
        }
        else {
            url = removeURLParameter(url, 'time_lo');
        }
        var time_hi = eventdata['xaxis.range[1]'];
        if (time_hi) {
            if (getParameterByName('granularity') == 'day')
                time_hi = time_hi.toString().slice(0,10);
            if (getParameterByName('granularity') == 'month')
                time_hi = time_hi.toString().slice(0,7)+'-01';
            url = updateURLParameter(url, 'time_hi', time_hi);
        }
        else {
            url = removeURLParameter(url, 'time_hi');
        }
        console.log(url);
        window.location.href = url;
    });
    */
</script>

<script>
var jsondata = [];

function load_projection() {
    const xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        //projection_data = JSON.parse(this.responseText);
        projection_data = add_randoms(JSON.parse(this.responseText));
        plotly_redraw();
    }
    url = build_url_from_form_entries('/json/projection');
    console.log('load_projection url='+url);
    xhttp.open("GET", url);
    xhttp.send();
}


function load_count() {
    const xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        count_data = JSON.parse(this.responseText);
        plotly_redraw();
    }
    url = build_url_from_form_entries('/json/count');
    console.log('load_count url='+url);
    xhttp.open("GET", url);
    xhttp.send();
}

function build_url_from_form_entries(url, form_entries) {
    elems = document.getElementById('form_search').elements;
    for (let i=0; i<elems.length; i++) {
        if (elems[i].name) {
            if (elems[i].type != 'checkbox' || elems[i].checked) {
                value = document.getElementById('form_search').elements[elems[i].name].value;
                url = updateURLParameter(url, elems[i].name, value);
            }
        }
    }
    return url;
}

var data_documents = [];
function load_documents() {
    {%for result in search_results%}
    data_documents.push(`
    <div class=result>
        <div class=result_host>
            <!--<img src=https://{{result.host}}/favicon.ico height=12px width=12px />-->
            {{result.date_published}} --
            <!-- {{result.accessed_at}} -- -->
            <a href='/host/{{result.host}}'>{{result.host}}</a>
            {{result.rank}}
            &nbsp;
            &nbsp;
            &nbsp;
            id={{result.id}}
        </div>
        <div class=result_title><a href="/metahtml?url={{result.url}}">{{result.title}}</a></div>
        <div class=result_description>{{result.description}}</div>
    </div>
    `);
    {%endfor%}
}

function draw_documents() {
    documents = document.getElementById('documents');
    for (let i=0; i<data_documents.length; i++) {
        documents.innerHTML += data_documents[i];
    }
}

load_all_data();
</script>
{% endblock %}
