{% extends "base.html" %}

{% block header %}
{% endblock %}

{% block content %}

<script>
let timeplot_data = [
    [{%for x in timeplot_data['xs']%} '{{x}}', {%endfor%}],
    [{%for y in timeplot_data['term_counts']%} {{y}}, {%endfor%}],
    [{%for y in timeplot_data['term_counts_lo']%} {{y}}, {%endfor%}],
    [{%for y in timeplot_data['term_counts_hi']%} {{y}}, {%endfor%}],
];
let sentiment_data_raw = [
    [{%for x in sentiment_data['xs']%} '{{x}}', {%endfor%}],
    [{%for y in sentiment_data['sentiments']%} {% if y %} {{y}} {% else %} null {%endif%}, {%endfor%}],
    [{%for y in sentiment_data['counts']%}     {% if y %} {{y}} {% else %} null {%endif%}, {%endfor%}],
];

// FIXME:
// real slow!
let randoms = [];
let xs = [];
let total_elements = sentiment_data_raw[2].reduce((a, b) => a + b, 0);
let total_randoms = Math.min(10000.0,total_elements);
let xs_index = 0;
let randoms_at_index = 0;
let variance = calc_variance(sentiment_data_raw[0]);

let prime1 = 16769023;
let prime2 = 1046527;

for (var i=0; i<total_randoms && xs_index <sentiment_data_raw[0].length; i++) {
    randoms_at_index += 1
    if (randoms_at_index > sentiment_data_raw[2][xs_index]/total_elements*total_randoms) {
        xs_index += 1;
        randoms_at_index = 0;
        i -= 1;
    }
    else {
        if (sentiment_data_raw[1][xs_index] !== null) {
            xs.push(sentiment_data_raw[0][xs_index])
            // FIXME:
            // this is real slow;
            // the same technique can generate 2 random numbers;
            // and we could use a faster random
            let r1 = Math.random();
            let r2 = Math.random();
            //let random = (-5*Math.log(r1)**1)*Math.cos(2*Math.PI*r2);
            let random = Math.sqrt(-2*Math.log(r1)**2)*Math.cos(2*Math.PI*r2);
            randoms.push(sentiment_data_raw[1][xs_index]+random*variance);
        }
    }
}

var add_randoms=true;
if (add_randoms) {
    var sentiment_data = [
        sentiment_data_raw[0].concat(xs),
        sentiment_data_raw[1].concat(randoms),
        ];
}
else {
    var sentiment_data = [
        sentiment_data_raw[0],
        sentiment_data_raw[1],
        ];
}

var sentiment_dots = 0;
for (let i=0; i<sentiment_data[1].length; i++) {
    if (sentiment_data[1][i]) {
        sentiment_dots += 1;
    }
}
</script>

<script>

function ema(xs,ys,alpha,weights) {
    var ys2 = [];
    var last_ys = null;
    var ema = ys[0];
    var beta = 0;
    for (var i=0; i<ys.length; i++) {
        if (ys[i] === null)
            next_ys = last_ys;
        else
            next_ys = ys[i];
        if (weights[i] > 0) {
            if (ema === null) 
                ema = next_ys;
            else
                beta = alpha**weights[i];
                ema = beta*ema + (1-beta)*next_ys;
            console.log('i='+i+', ema='+ema);
        }
        ys2.push(ema);
        last_ys = next_ys;
    }
    return ys2;
}
function ema_simple(xs,ys,alpha,weights=null) {
    var ys2 = [];
    var last_ys = null;
    var ema = ys[0];
    for (var i=0; i<ys.length; i++) {
        if (ys[i] === null)
            next_ys = last_ys;
        else
            next_ys = ys[i];
        ema = alpha*ema + (1-alpha)*next_ys;
        ys2.push(ema);
        last_ys = next_ys;
    }
    return ys2;
}
</script>

<aside id=aside_xy style='grid-row: 1'>
    <h3>Mentions Options</h3>
    <ul>
        <li>axis
            <select name="mentions_axis" id="mentions_axis" form=form_search>>
              <option value="host"    {%if mentions_axis=="host"     %}selected{%endif%}>host</option>
              <option value="hostpath"{%if mentions_axis=="hostpath" %}selected{%endif%}>hostpath</option>
            </select>
            <script>
                document.getElementById('mentions_axis').addEventListener('change', function(e) {
                    document.getElementById('form_search').submit();
                });
            </script>
        </li>
        <li>normalization
            <select name="normalize" id="normalize" form=form_search>>
              <option value="none" {%if normalize=="none"     %}selected{%endif%}>none</option>
              <option value="total"{%if normalize=="total"    %}selected{%endif%}>total</option>
              {% for selected,term_combination in terms_combinations_pretty %}
              <option value='query:{{term_combination|safe}}' {%if selected%}selected{%endif%}>query:{{term_combination|safe}}</option>
              {% endfor %}
            </select>
            <script>
                document.getElementById('normalize').addEventListener('change', function(e) {
                    document.getElementById('form_search').submit();
                });
            </script>
        </li>
        <li>granularity
            <select name="granularity" id="granularity" form=form_search>
              <option value="year"  {%if granularity=="year" %}selected{%endif%}>year</option>
              <option value="month" {%if granularity=="month"%}selected{%endif%}>month</option>
              <option value="day"   {%if granularity=="day"  %}selected{%endif%}>day</option>
            </select>
            <script>
                document.getElementById('granularity').addEventListener('change', function(e) {
                    document.getElementById('form_search').submit();
                });
            </script>
        </li>
    </ul>
</aside>
<aside id=aside_x2y2 style='grid-row:2'>
    <h3>Projection Options</h3>
    <ul>
        <li>axis
            <select name=projection_axis id=projection_axis form=form_search>
            </select>
            <script>
                var axis_dictionary = {
                    'anger': ['angry agitated', 'calm serene'],
                    'gender': ['male father king he', 'female mother queen she'],
                    'happiness': ['happy joy pleasure delight', 'sad misery dissatisfaction bore'],
                    'intelligence': ['intelligent', 'stupid'],
                    'freedom': ['freedom', 'oppression'],
                    'scary': ['scary afraid fear', 'relaxing unafraid comfort'], 
                    'sentiment': ['positive good better best', 'negative bad worse worst'], 
                    'success': ['successful', 'failed'],
                    'threat': ['danger war menace enemy', 'safety peace friend ally'],
                    'war': ['war', 'peace'],
                    'wealth': ['wealth affluence rich asset', 'debt poverty poor liability'],
                    //'life': ['alive active awake living', 'dead inactive asleep dying'],
                    //'erotic': ['erotic sexy sensual', 'unerotic polite propper'],
                };
                projection_axis = getParameterByName('projection_axis');
                select = document.getElementById('projection_axis')
                for (key in axis_dictionary) {
                    option = document.createElement("option");
                    option.textContent = key;
                    option.value = key;
                    if (projection_axis == key) {
                        option.selected = 'selected';
                    }
                    select.add(option);
                }
                select.addEventListener('change', function(e) {
                    document.getElementById('pos_words').value = axis_dictionary[e.currentTarget.value][0];
                    document.getElementById('neg_words').value = axis_dictionary[e.currentTarget.value][1];
                    document.getElementById('form_search').submit();
                });
            </script>
            <br>
            pos words <input id=pos_words name=pos_words form=form_search readonly value="{{pos_words}}">
            <br>
            neg words <input id=neg_words name=neg_words form=form_search readonly value="{{neg_words}}">
        </li>
        <li>window size 
            <br>
            <input type="range"  id="window_size_range" min="1" max="365" value="180" oninput="set_window_size(this.value)" />
            <br>
            <input type="number" id="window_size_number" min="1" max="365" value="180" step=30 oninput="set_window_size(this.value)" />
            <script>
            function set_window_size(window_size) {
                document.getElementById('window_size_range').value = window_size;
                document.getElementById('window_size_number').value = window_size;
                trace3.y = moving_average([],sentiment_data_raw[1],window_size,sentiment_data_raw[2]);
                Plotly.redraw('plotly',data);
                //Plotly.react('plotly');
                // FIXME:
                // redraw() is slow because it redraws everything;
                // we should only replot the changed traces
            }
            </script>
        </li>
    </ul>
</aside>

<div style='display:grid; grid-column:1; grid-row:1;'>
    <h2 class=label>Counts</h2>
</div>
<div style='display:grid; grid-column:1; grid-row:2;'>
    <h2 class=label>Projection</h2>
</div>
<div id=plotly></div>


<script>
// taken from: https://stackoverflow.com/questions/847185/convert-a-unix-timestamp-to-time-in-javascript
function timeConverter(UNIX_timestamp){
  var a = new Date(UNIX_timestamp * 1000);
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var year = a.getFullYear();
  var month = 1+a.getMonth(); //months[a.getMonth()];
  var date = a.getDate();
  var hour = a.getHours();
  var min = a.getMinutes();
  var sec = a.getSeconds();
  return year+'-'+month+'-'+date;// +' ' + hour + ':' + min + ':' + sec ;
  //var time = date + ' ' + month + ' ' + year ; //+ ' ' + hour + ':' + min + ':' + sec ;
  //return time;
}

var type = 'scattergl';
var trace1 = {
  x: timeplot_data[0], //.map(timeConverter),
  y: timeplot_data[1],
  name: 'rate',
  /*
  type: 'bar',
  bargap: 0.0,
  bargroupgap: 0.0,
  */
  //hoverinfo: 'skip',
  hovermode: 'closest',
  type: type,
  line: {
    shape: 'hv',
    color: '#55f',
    width: 1,
  },
  marker: {
    size: 3,
  },
};

var trace2 = {
  x: sentiment_data[0], //.map(timeConverter),
  y: sentiment_data[1],
  xaxis: 'x2',
  yaxis: 'y2',
  type: type,
  hoverinfo: 'skip',
  line: {
    shape: 'hv',
    color: '#55f',
    width: 1,
  },
  mode: 'markers',
}
if (add_randoms) {
  trace2.marker = {
    size: 4*(1-sentiment_dots/10000),
    color: '#ccf',
  };
  console.log('marker');
  console.log(4 * (1-sentiment_dots/10000));
}
else {
  trace2.marker = {
    size: 3,
    color: '#00f',
  };
}

var trace3 = {
  x: sentiment_data[0], //.map(timeConverter),
  y: moving_average([],sentiment_data_raw[1],180,sentiment_data_raw[2]),
  xaxis: 'x2',
  yaxis: 'y2',
  type: type,
  hoverinfo: 'skip',
  line: {
    shape: 'spline',
    color: '#55f',
    width: 1,
  },
  marker: {
    size: 1,
  },
};


var data = [trace1, trace2, trace3];

var layout = {
    grid: {rows: 2, columns: 1}, //, pattern: 'independent'},
    showlegend: false,
    //margin: {pad: 0},
    //height: 500,
    margin:{
        l:60,
        r:0,
        t:0,
        b:0,
        pad:0,
    },
    xaxis: {
        autorange: true,
        rangeselector: {
          buttons: [
            {
              count: 1,
              label: '1y',
              step: 'year',
              stepmode: 'backward'
            },
            {
              count: 10,
              label: '10y',
              step: 'year',
              stepmode: 'backward'
            },
            {
              count: 100,
              label: '100y',
              step: 'year',
              stepmode: 'backward'
            },
            {step: 'all'}
          ]},
        //rangeslider: {},
        type: 'date'
    },
    xaxis2: {
      matches: 'x',
    },
    yaxis: {
      fixedrange: true,
      rangemode: 'tozero',
      title: {
        text: 'mentions',
        font: {
          family: 'Courier New, monospace',
          size: 18,
          color: '#7f7f7f'
        }
      }
    },
    yaxis2: {
      fixedrange: true,
      rangemode: 'tozero',
      title: {
        text: 'projection',
        font: {
          family: 'Courier New, monospace',
          size: 18,
          color: '#7f7f7f'
        }
      }
    }
};

Plotly.newPlot('plotly', data, layout, {displaylogo: false});

document.getElementById('plotly').on('plotly_relayout',
function(eventdata){
    var url = window.location.href;
    var time_lo = eventdata['xaxis.range[0]'];
    if (time_lo) {
        if (getParameterByName('granularity') == 'day')
            time_lo = time_lo.toString().slice(0,10);
        if (getParameterByName('granularity') == 'month')
            time_lo = time_lo.toString().slice(0,7)+'-01';
        url = updateURLParameter(url, 'time_lo', time_lo);
    }
    else {
        url = removeURLParameter(url, 'time_lo');
    }
    var time_hi = eventdata['xaxis.range[1]'];
    if (time_hi) {
        if (getParameterByName('granularity') == 'day')
            time_hi = time_hi.toString().slice(0,10);
        if (getParameterByName('granularity') == 'month')
            time_hi = time_hi.toString().slice(0,7)+'-01';
        url = updateURLParameter(url, 'time_hi', time_hi);
    }
    else {
        url = removeURLParameter(url, 'time_hi');
    }
    console.log(url);
    window.location.href = url;
});
</script>


<aside style="grid-row:3">
    <h3>Document Options</h3>
Order by
<select name="orderby" id="orderby">
  <option value="none"      {%if orderby=="none"     %}selected{%endif%}>none</option>
  <option value="time_desc" {%if orderby=="time_desc"%}selected{%endif%}>publication date (descending)</option>
  <option value="time_asc"  {%if orderby=="time_asc" %}selected{%endif%}>publication date (ascending)</option>
  <option value="rank"      {%if orderby=="rank"     %}selected{%endif%}>relevance</option>
</select>
<script>
function orderby_onchange(e) {
    window.location.href = updateURLParameter(window.location.href, 'orderby', e.currentTarget.value);
}
document.getElementById('orderby').addEventListener('change', orderby_onchange);
</script>
</aside>

<div style='display:grid; grid-column:1; grid-row:3'>
    <h2 class=label>Documents</h2>
</div>
<div style='display:grid; grid-column:2; grid-row:3'>

{%for result in search_results%}
<div class=result>
    <div class=result_host>
        <!--<img src=https://{{result.host}}/favicon.ico height=12px width=12px />-->
        {{result.date_published}} --
        <!-- {{result.accessed_at}} -- -->
        <a href='/host/{{result.host}}'>{{result.host}}</a>
        {{result.rank}}
        &nbsp;
        &nbsp;
        &nbsp;
        id={{result.id}}
    </div>
    <div class=result_title><a href="/metahtml?url={{result.url}}">{{result.title}}</a></div>
    <div class=result_description>{{result.description}}</div>
</div>
{%endfor%}
</div>

<script>
/*
var jsondata = [];
function load_projection() {
    const xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        jsondata.projection = JSON.parse(this.responseText);
        console.log(jsondata);
    }
    xhttp.open("GET", "/json/projection", true);
    xhttp.send();
}
function load_count() {
    const xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        jsondata.count = JSON.parse(this.responseText);
        console.log(jsondata);
    }
    xhttp.open("GET", "/json/mention", true);
    xhttp.send();
}
load_projection();
*/
</script>
{% endblock %}
